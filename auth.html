<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // 1) CONFIG
  const SUPABASE_URL = "https://cjzjipuwdviorqsihsmr.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_GTdIzH-9DAlh39wyKfPIZA_rtxwek0O"; // sb_publishable_...

  // 2) CLIENT
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // 3) HELPERS
  const $ = (id) => document.getElementById(id);

  function showAuth(){
    $("auth").classList.remove("hidden");
    $("profile").classList.add("hidden");
  }
  function showProfile(){
    $("auth").classList.add("hidden");
    $("profile").classList.remove("hidden");
  }

  // 4) ACTIONS
  async function signup(){
    const email = $("email").value.trim();
    const password = $("password").value.trim();

    if(!email) return alert("Inserisci una email");
    if(password.length < 6) return alert("Password minimo 6 caratteri");

    const { data, error } = await sb.auth.signUp({ email, password });
    if(error) return alert(error.message);

    // se conferma email attiva, sessione è null (sembra che “non vada avanti”)
    if(!data.session){
      alert("Registrazione OK ✅\nOra controlla la mail per confermare, poi fai Login.\n(Se vuoi test rapido: disattiva Confirm email su Supabase)");
      return;
    }

    showProfile();
  }

  async function login(){
    const email = $("email").value.trim();
    const password = $("password").value.trim();

    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error) return alert(error.message);

    showProfile();
  }

  async function logout(){
    await sb.auth.signOut();
    showAuth();
  }

  async function saveProfile(){
    const { data: userData, error: userErr } = await sb.auth.getUser();
    if(userErr) return alert(userErr.message);
    if(!userData.user) return alert("Devi essere loggato.");

    const payload = {
      id: userData.user.id,
      username: $("username").value.trim() || null,
      bio: $("bio").value.trim() || null
    };

    const { error } = await sb.from("profiles").upsert(payload);
    if(error) return alert(error.message);

    alert("Profilo salvato ✅");
  }

  // 5) INIT
  (async ()=>{
    const { data } = await sb.auth.getSession();
    if(data.session) showProfile();
    else showAuth();
  })();

  // 6) expose for onclick=""
  window.signup = signup;
  window.login = login;
  window.logout = logout;
  window.saveProfile = saveProfile;
</script>
