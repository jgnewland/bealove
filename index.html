<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>beabook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --rose:#B45B63;
      --rose2:#C56A72;
      --bg0:#070708;
      --bg1:#0B0B0C;
      --panel:rgba(20,20,24,.55);
      --panel2:rgba(14,14,18,.72);
      --line:rgba(255,255,255,.12);
      --line2:rgba(255,255,255,.16);
      --txt:#fff;
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --shadow: 0 26px 80px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:14px;
      --font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--txt);
      background:
        radial-gradient(1100px 700px at 15% 10%, rgba(180,91,99,.28), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(180,91,99,.16), transparent 65%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 55%, var(--bg0));
      overflow-x:hidden;
    }
    a{color:inherit;text-decoration:none}
    button{font-family:inherit}

    .wrap{max-width:1240px;margin:0 auto;padding:0 18px 48px}

    /* TOPBAR */
    .topbar{
      position:sticky; top:0; z-index:60;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(7,7,8,.92), rgba(7,7,8,.62), rgba(7,7,8,.38));
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .topbar-inner{
      max-width:1240px;margin:0 auto;
      padding:12px 18px;
      display:flex; align-items:center; gap:12px;
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:170px}
    .brand img{height:34px;display:block}
    .nav{
      display:flex; gap:8px; align-items:center;
      padding:6px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius:999px;
    }
    .nav a{
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:rgba(255,255,255,.78);
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    .nav a.active{
      background: rgba(180,91,99,.22);
      border:1px solid rgba(180,91,99,.55);
      color:#fff;
    }

    .spacer{flex:1}

    .search{
      flex:1; max-width:560px;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(15,15,18,.55);
      border-radius:999px;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      position:relative;
      min-width:220px;
    }
    .search input{
      width:100%;
      border:none; outline:none;
      background:transparent;
      color:#fff;
      font-size:13px;
    }
    .suggest{
      position:absolute;
      top:calc(100% + 8px);
      left:0; right:0;
      background: rgba(12,12,14,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
    }
    .suggest.open{display:block}
    .suggest .rowS{
      display:flex; flex-wrap:wrap; gap:8px;
      padding:12px;
    }
    .chip{
      cursor:pointer;
      display:inline-flex;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.82);
      font-size:12px;
      text-transform:lowercase;
    }
    .chip:hover{border-color:rgba(180,91,99,.70)}

    .cta{display:flex; gap:10px; align-items:center}
    .btn{
      border:none; cursor:pointer;
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      font-weight:800;
      color:#0e0e10;
      background: linear-gradient(135deg, #fff, rgba(255,255,255,.85));
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
    }
    .btn:active{transform:translateY(1px)}
    .btn.ghost{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:#fff;
      box-shadow:none;
    }
    .btn.primary{
      background: linear-gradient(135deg, var(--rose), var(--rose2));
      color:#fff;
      box-shadow: 0 20px 70px rgba(180,91,99,.25);
    }

    /* HERO */
    .hero{
      padding:22px 0 10px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:18px;
      align-items:stretch;
    }
    .hero-left{
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(20,20,24,.68), rgba(12,12,14,.45));
      box-shadow: var(--shadow);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .hero-left:before{
      content:"";
      position:absolute; inset:-140px -140px auto auto;
      width:460px;height:460px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(180,91,99,.34), transparent 62%);
      pointer-events:none;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      font-size:11px;
      color: rgba(255,255,255,.78);
      letter-spacing:.10em;
      text-transform:uppercase;
    }
    .dot{width:7px;height:7px;border-radius:50%;background:var(--rose);box-shadow:0 0 16px rgba(180,91,99,.35)}
    .hero-left h1{
      margin:12px 0 8px;
      font-size: clamp(28px, 3.6vw, 46px);
      line-height:1.06;
      letter-spacing:-.02em;
    }
    .hero-left p{margin:0;color:var(--muted);font-size:14px;max-width:70ch}
    .hero-actions{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .mini{color:rgba(255,255,255,.68);font-size:12px}
    .hero-right{display:grid;gap:12px}
    .box{
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(20,20,24,.60), rgba(12,12,14,.42));
      box-shadow: 0 18px 60px rgba(0,0,0,.50);
      overflow:hidden;
    }

    .feature-cover{
      height:190px;
      background:
        linear-gradient(180deg, rgba(0,0,0,.00), rgba(0,0,0,.62));
      background-size:cover;
      background-position:center;
      position:relative;
      cursor:pointer;
    }
    .feature-badge{
      position:absolute; left:12px; top:12px;
      display:inline-flex; gap:6px; align-items:center;
      padding:6px 10px; border-radius:999px;
      background: rgba(14,14,16,.55);
      border:1px solid rgba(255,255,255,.16);
      font-size:11px; color:#fff;
      backdrop-filter: blur(10px);
    }
    .feature-body{padding:12px}
    .feature-body h3{margin:0 0 6px;font-size:15px}
    .feature-body p{margin:0;color:rgba(255,255,255,.72);font-size:13px}

    /* PRO CTA */
    .pro-cta{
      width:100%;
      border:none;
      cursor:pointer;
      border-radius:16px;
      padding:12px 14px;
      text-align:left;
      color:#fff;
      background:
        radial-gradient(700px 220px at 10% 20%, rgba(255,255,255,.18), transparent 60%),
        linear-gradient(135deg, var(--rose), #8E3E46);
      box-shadow: 0 24px 70px rgba(180,91,99,.30);
      border:1px solid rgba(255,255,255,.16);
      position:relative;
      overflow:hidden;
    }
    .pro-cta b{display:block;font-size:14px;letter-spacing:.04em}
    .pro-cta span{display:block;font-size:12px;color:rgba(255,255,255,.80);margin-top:4px}
    .pro-cta small{
      display:inline-flex;
      margin-top:10px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(14,14,16,.35);
      border:1px solid rgba(255,255,255,.16);
      font-size:12px;
    }

    /* SECTIONS */
    .section{margin-top:18px}
    .section-head{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      margin: 18px 0 10px;
    }
    .section-head h2{
      margin:0;
      font-size:15px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:rgba(255,255,255,.92);
    }
    .section-head .sub{margin:0;color:rgba(255,255,255,.68);font-size:12px}

    /* SLIDER ROW */
    .row{
      display:flex; gap:14px;
      overflow-x:auto;
      padding-bottom:10px;
      scroll-snap-type:x mandatory;
    }
    .row::-webkit-scrollbar{height:8px}
    .row::-webkit-scrollbar-thumb{background:rgba(255,255,255,.18);border-radius:999px}

    .card{
      flex: 0 0 200px;
      scroll-snap-align:start;
      border-radius: var(--radius2);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(20,20,24,.42);
      overflow:hidden;
      cursor:pointer;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .card:hover{
      transform: translateY(-4px);
      border-color: rgba(180,91,99,.70);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
    }
    .cover{
      aspect-ratio: 3/4;
      background-size:cover;
      background-position:center;
      background-color: rgba(255,255,255,.06);
      position:relative;
    }
    .cover:after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.00), rgba(0,0,0,.78));
    }
    .cover .meta{
      position:absolute; left:10px; right:10px; bottom:10px; z-index:2;
    }
    .genre{
      display:inline-flex;
      padding:5px 9px;
      border-radius:999px;
      background: rgba(14,14,16,.52);
      border:1px solid rgba(255,255,255,.16);
      font-size:11px; color:#fff;
      backdrop-filter: blur(10px);
      text-transform:lowercase;
    }
    .title{
      margin:8px 0 0;
      font-size:14px;
      font-weight:900;
      line-height:1.2;
    }
    .info{
      padding:10px 11px 12px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .by{
      color:rgba(255,255,255,.78);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:120px;
    }
    .stat{
      font-size:12px; color:rgba(255,255,255,.70);
      border:1px solid rgba(255,255,255,.14);
      padding:4px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.05);
      white-space:nowrap;
    }

    /* OVERLAYS */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.68);
      backdrop-filter: blur(10px);
      display:none;
      z-index:80;
    }
    .overlay.open{display:block}

    .sheet{
      position:absolute; inset:12px;
      border-radius: 22px;
      background:
        radial-gradient(1000px 500px at 20% 0%, rgba(180,91,99,.22), transparent 60%),
        linear-gradient(180deg, rgba(18,18,22,.92), rgba(10,10,12,.92));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .sheet-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(10,10,12,.42);
    }
    .sheet-title{
      color:rgba(255,255,255,.75);
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    .back{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: #fff;
      border-radius: 12px;
      padding:9px 12px;
      cursor:pointer;
      font-weight:800;
    }

    /* STORY VIEW */
    .sheet-body{
      display:grid;
      grid-template-columns: 1fr 380px;
      gap:14px;
      padding:14px;
      overflow:auto;
      height:100%;
    }
    .story-hero{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(255,255,255,.04);
    }
    .story-cover{
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:14px;
      padding:14px;
      align-items:start;
    }
    .coverFull{
      width:100%;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      cursor:pointer;
    }
    .coverFull img{
      width:100%;
      height:auto;
      display:block;
    }
    .story-meta h1{
      margin:0 0 8px;
      font-size:26px;
      letter-spacing:-.02em;
      line-height:1.1;
    }
    .story-meta p{margin:0;color:rgba(255,255,255,.75);font-size:13px}
    .panel{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      padding:12px;
      margin-top:12px;
    }
    .panel h3{
      margin:0 0 10px;
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,.72);
    }
    .content{color: rgba(255,255,255,.92);font-size:14px;line-height:1.55}
    .chaplist{display:flex;flex-direction:column;gap:10px}
    .chap{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      border-radius: 16px;
      padding:10px;
    }
    .chap .foot{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      color:rgba(255,255,255,.70);
      font-size:12px;
      margin-top:10px;
    }
    .vote{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:#fff;
      border-radius: 999px;
      padding:6px 10px;
      cursor:pointer;
      display:inline-flex; gap:6px; align-items:center;
      font-weight:800;
    }
    .vote:hover{border-color: rgba(180,91,99,.70)}
    .side .panel{position:sticky; top:0}
    .field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
    .field label{color:rgba(255,255,255,.70);font-size:12px}
    .field select, .field input{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: #fff;
      padding:10px;
      outline:none;
      font-size:13px;
    }

    /* LIGHTBOX */
    .lightbox{
      position:fixed; inset:0;
      background: rgba(0,0,0,.92);
      display:none;
      z-index:120;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .lightbox.open{display:flex}
    .lightbox img{
      max-width:95vw;
      max-height:92vh;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      background:#000;
    }

    /* EDITOR FULLSCREEN */
    .editor{
      position:fixed; inset:0;
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(180,91,99,.22), transparent 60%),
        linear-gradient(180deg, rgba(8,8,10,.98), rgba(8,8,10,.98));
      display:none;
      z-index:110;
    }
    .editor.open{display:block}
    .editorShell{
      position:absolute; inset:12px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,10,12,.84);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .editorTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(10,10,12,.50);
    }
    .editorTop .title{
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,.72);
      margin:0;
    }
    .editorBody{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:14px;
      padding:14px;
      overflow:auto;
      height:100%;
    }

    .box2{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      padding:12px;
    }
    .box2 h3{
      margin:0 0 10px;
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,.72);
    }
    .grid2{display:grid; gap:10px}
    .grid2 input, .grid2 select{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:#fff;
      padding:10px;
      outline:none;
      font-size:13px;
    }
    .coverPick{display:grid;grid-template-columns:1fr;gap:10px}
    .coverPreview{
      aspect-ratio: 3/4;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.20);
      background: rgba(255,255,255,.03);
      display:grid;
      place-items:center;
      color:rgba(255,255,255,.68);
      overflow:hidden;
      cursor:pointer;
      position:relative;
    }
    .coverPreview img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .coverHint{
      position:absolute;
      bottom:10px; left:10px; right:10px;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:8px 10px;
      font-size:12px;
      color:rgba(255,255,255,.82);
      backdrop-filter: blur(10px);
      display:none;
    }
    .coverPreview.has .coverHint{display:block}

    /* TOOLBAR */
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      padding:10px;
      border:1px solid rgba(255,255,255,.10);
      border-bottom:none;
      border-radius: 18px 18px 0 0;
      background: rgba(255,255,255,.04);
    }
    .toolbtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:#fff;
      border-radius: 12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .toolbtn:hover{border-color: rgba(180,91,99,.70)}
    .toolsel{
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:#fff;
      padding:8px 10px;
      outline:none;
      font-size:12px;
    }
    .toolsep{width:1px;height:26px;background:rgba(255,255,255,.12);margin:0 2px}

    /* EDITABLE */
    .editable{
      border:1px solid rgba(255,255,255,.10);
      border-top:none;
      border-radius: 0 0 18px 18px;
      background: rgba(0,0,0,.18);
      padding:14px;
      min-height:460px;
      outline:none;
      line-height:1.7;
      font-size:16px;
      overflow:auto;
      white-space:pre-wrap;
    }
    .helpRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
      color:rgba(255,255,255,.70);
      font-size:12px;
    }
    .limitMsg{
      display:none;
      color: #ffd0d5;
      background: rgba(180,91,99,.18);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;
      border-radius: 14px;
    }
    .limitMsg.show{display:block}

    /* COVER BADGE on cards if broken */
    .coverBad{
      position:absolute; left:10px; right:10px; top:10px;
      z-index:3;
      display:none;
      padding:8px 10px;
      border-radius:12px;
      background: rgba(180,91,99,.24);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(255,255,255,.92);
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      backdrop-filter: blur(8px);
    }
    .cover.bad .coverBad{display:block}
    .cover.bad{background-image:none !important}

    @media (max-width: 1100px){
      .hero{grid-template-columns:1fr}
      .sheet-body{grid-template-columns:1fr}
      .side .panel{position:relative}
      .editorBody{grid-template-columns:1fr}
      .story-cover{grid-template-columns:1fr}
      .coverFull{max-width:320px}
    }
    @media (max-width: 640px){
      .nav{display:none}
      .search{min-width:0}
      .card{flex-basis:170px}
      .sheet{inset:10px}
      .editorShell{inset:10px}
      .coverFull{max-width:100%}
    }

    /* =========================
       HAMBURGER MENU (MOBILE)
    ========================= */

    /* Desktop: nav su una riga */
    .topbar-inner{ flex-wrap: nowrap; }
    .nav{ flex-wrap: nowrap; white-space: nowrap; }
    .nav a{ white-space: nowrap; }

    /* Mobile: nascondi nav e mostra hamburger */
    @media (max-width: 820px){
      .nav{ display:none !important; }
      #hambBtn{ display:inline-flex !important; align-items:center; justify-content:center; }
    }

    /* =========================
       MOBILE FIX (TOPBAR + SEARCH + CTA)
    ========================= */

    html, body { overflow-x: hidden; }

    @media (max-width: 820px){
      .topbar-inner{
        flex-wrap: wrap;
        gap:10px;
      }

      .brand{ min-width: auto; }
      .brand img{ height:28px; }

      .spacer{ display:none; }

      .cta{
        margin-left:auto;
        gap:8px;
      }

      .search{
        order: 99;
        width: 100%;
        max-width: none;
        border-radius: 16px;
      }

      .nav{ display:none !important; }
      #hambBtn{ display:inline-flex !important; }

      #randomBtn,
      #newStoryBtn{
        display:none !important;
      }

      .suggest{
        left:0;
        right:0;
        width:100%;
        max-height: 260px;
        overflow:auto;
        z-index:200;
      }
    }

    @media (max-width: 420px){
      .topbar-inner{ padding:10px 12px; }
      .btn{ padding:9px 12px; font-size:12px; }
    }

    /* =========================
       MOBILE COMPACT LAYOUT
    ========================= */
    @media (max-width: 820px){
      .wrap{ padding:0 12px 32px; }
      .hero{
        padding:14px 0 6px;
        gap:12px;
      }
      .hero-left{
        padding:14px;
        border-radius:16px;
      }
      .hero-left h1{
        font-size:26px;
        line-height:1.05;
        margin:10px 0 8px;
      }
      .hero-left p{
        font-size:13px;
        line-height:1.45;
      }
      .hero-actions{
        margin-top:12px;
        gap:8px;
      }
      .mini{ display:none; }

      .hero-right{ gap:10px; }
      .box{ border-radius:16px; }
      .feature-cover{ height:150px; }
      .feature-body{ padding:10px 12px; }
      .feature-body h3{ font-size:14px; }
      .feature-body p{ font-size:12.5px; }

      .section{ margin-top:14px; }
      .section-head{ margin:14px 0 8px; }
      .section-head h2{ font-size:13px; }
      .section-head .sub{ font-size:11.5px; }

      .row{ gap:10px; padding-bottom:8px; }
      .card{ flex: 0 0 150px; border-radius:14px; }
      .title{ font-size:13px; }
      .info{ padding:8px 10px 10px; }
      .by{ font-size:11.5px; max-width:92px; }
      .stat{ font-size:11px; padding:3px 7px; }

      .sheet{ inset:10px; border-radius:18px; }
      .sheet-body{ padding:10px; gap:10px; }
      .story-cover{ padding:10px; gap:10px; }
      .story-meta h1{ font-size:20px; }
      .panel{ border-radius:16px; padding:10px; }
      .content{ font-size:13px; line-height:1.5; }

      .editorShell{ inset:10px; border-radius:18px; }
      .editorBody{ padding:10px; gap:10px; }
      .toolbar{ border-radius:16px 16px 0 0; }
      .editable{
        min-height:360px;
        font-size:15px;
        line-height:1.65;
        padding:12px;
      }

      .chip{ padding:6px 9px; font-size:11px; }
    }

    @media (max-width: 420px){
      .hero-left h1{ font-size:24px; }
      .feature-cover{ height:135px; }
      .card{ flex: 0 0 140px; }
      .title{ font-size:12.5px; }
      .genre{ font-size:10.5px; padding:4px 8px; }
      .stat{ font-size:10.5px; }
      .btn{ padding:9px 12px; font-size:12px; }
      .back{ padding:8px 10px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <img alt="beabook" src="https://raw.githubusercontent.com/jgnewland/bealove/main/LOGO%20BEABOOK.png">
      </div>

      <div class="nav" aria-label="menu" id="topNav">
        <a href="#home" class="active" id="navHome">Home</a>
        <a href="#featured" id="navFeatured">In evidenza</a>
        <a href="#new" id="navNew">Nuove</a>
        <a href="#loved" id="navLoved">Pi√π amate</a>
      </div>

      <div class="spacer"></div>

      <div class="search">
        <span style="opacity:.9">üîé</span>
        <input id="q" autocomplete="off" placeholder="Cerca racconti, autori, generi‚Ä¶" />
        <div class="suggest" id="suggest">
          <div style="padding:10px 12px 0;color:rgba(255,255,255,.62);font-size:11px;letter-spacing:.12em;text-transform:uppercase">
            Suggerimenti generi
          </div>
          <div class="rowS" id="chips"></div>
        </div>
      </div>

      <!-- ‚úÖ CTA CON AUTH -->
      <div class="cta">
        <button class="btn ghost" id="hambBtn" aria-label="Apri menu" style="display:none">‚ò∞</button>

        <span id="bbUserBadge" style="color:rgba(255,255,255,.75);font-size:12px;margin-right:6px"></span>
        <button class="btn ghost" id="bbLoginBtn">Accedi</button>
        <button class="btn ghost" id="bbLogoutBtn" style="display:none">Logout</button>

        <button class="btn ghost" id="randomBtn">üé≤ Random</button>
        <button class="btn primary" id="newStoryBtn">‚úçÔ∏è Crea nuova storia</button>
      </div>
    </div>
  </div>

  <div class="wrap" id="home">
    <section class="hero">
      <div class="hero-left">
        <span class="pill"><span class="dot"></span> scrittura collettiva ‚Ä¢ beta</span>
        <h1>Racconti brevi, intensi, collaborativi.</h1>
        <p>
          Ogni storia vive per capitoli: scrivi un pezzo (max 30 righe), poi passa il testimone.
          Vota le continuazioni migliori e costruisci un romanzo insieme agli altri.
        </p>
        <div class="hero-actions">
          <button class="btn primary" id="browseBtn">Sfoglia le storie</button>
          <button class="btn ghost" id="openProBtn">Scopri PRO</button>
          <span class="mini">Consiglio: premi <b>CTRL+K</b> per cercare.</span>
        </div>
      </div>

      <div class="hero-right">
        <div class="box">
          <div class="feature-cover" id="featuredClickable">
            <div class="feature-badge">üî• In evidenza ‚Ä¢ <span id="featuredGenre">‚Äî</span></div>
          </div>
          <div class="feature-body">
            <h3 id="featuredTitle">‚Äî</h3>
            <p id="featuredDesc">‚Äî</p>
          </div>
        </div>

        <div class="box">
          <div class="feature-body">
            <h3>Una community, un racconto per volta.</h3>
            <p>Con PRO trasformi la storia in un progetto editoriale (selezione capitoli + impaginazione + boost).</p>
            <button class="pro-cta" id="proCtaBtn">
              <b>beabook PRO</b>
              <span>Tool editoriali + impaginazione + storia in evidenza.</span>
              <small>demo UI ¬∑ pagamento non attivo</small>
            </button>
          </div>
        </div>
      </div>
    </section>

    <section class="section" id="featured">
      <div class="section-head">
        <div>
          <h2>In evidenza</h2>
          <p class="sub">Pi√π continuazioni = pi√π energia.</p>
        </div>
        <p class="sub">Scorri ‚Üí</p>
      </div>
      <div class="row" id="rowFeatured"></div>
    </section>

    <section class="section" id="new">
      <div class="section-head">
        <div>
          <h2>Nuove uscite</h2>
          <p class="sub">Appena nate. Seleziona e continua.</p>
        </div>
        <p class="sub">Scorri ‚Üí</p>
      </div>
      <div class="row" id="rowNew"></div>
    </section>

    <section class="section" id="loved">
      <div class="section-head">
        <div>
          <h2>Pi√π amate</h2>
          <p class="sub">Le continuazioni con pi√π ‚ù§.</p>
        </div>
        <p class="sub">Scorri ‚Üí</p>
      </div>
      <div class="row" id="rowLoved"></div>
    </section>
  </div>

  <!-- STORY OVERLAY -->
  <div class="overlay" id="storyOverlay">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheet-top">
        <button class="back" id="storyBack">‚Üê Indietro</button>
        <div class="sheet-title">Racconto</div>
        <button class="btn primary" id="continueBtn">Continua la storia</button>
      </div>

      <div class="sheet-body">
        <div>
          <div class="story-hero">
            <div class="story-cover">
              <div class="coverFull" id="storyCoverClick" title="Clicca per vedere la copertina intera">
                <img id="storyCoverImg" alt="copertina">
              </div>

              <div class="story-meta">
                <span class="genre" id="storyGenre"></span>
                <h1 id="storyTitle"></h1>
                <p id="storyMeta"></p>
                <div class="panel">
                  <h3>Incipit</h3>
                  <div class="content" id="storyIncipit"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="panel">
            <h3>Continuazioni</h3>
            <div class="chaplist" id="chapList"></div>
          </div>
        </div>

        <div class="side">
          <div class="panel">
            <h3>Statistiche</h3>
            <div class="content" id="storyStats"></div>

            <div class="field">
              <label>Ordina continuazioni</label>
              <select id="chapSort">
                <option value="top">Pi√π votate</option>
                <option value="new">Pi√π recenti</option>
              </select>
            </div>

            <div class="field">
              <label>Cerca nelle continuazioni</label>
              <input id="chapFilter" placeholder="Una parola‚Ä¶" />
            </div>

            <p class="content" style="color:rgba(255,255,255,.68);font-size:12px;margin-top:10px">
              Vota con ‚ù§. Scrivi al massimo 30 righe per continuazione.
            </p>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- LIGHTBOX -->
  <div class="lightbox" id="lightbox">
    <img id="lightboxImg" alt="copertina intera">
  </div>

  <!-- PRO OVERLAY -->
  <div class="overlay" id="proOverlay">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheet-top">
        <button class="back" id="proBack">‚Üê Chiudi</button>
        <div class="sheet-title">beabook PRO</div>
        <button class="btn primary" id="proActivate">Attiva PRO</button>
      </div>
      <div class="sheet-body" style="grid-template-columns:1.2fr .8fr">
        <div>
          <div class="panel" style="margin-top:0">
            <h3>Cos‚Äô√® PRO</h3>
            <div class="content" style="color:rgba(255,255,255,.82)">
              PRO trasforma un racconto collaborativo in un ‚Äúprogetto editoriale‚Äù:
              selezione capitoli migliori, struttura, indice e impaginazione.
            </div>
          </div>

          <div class="panel">
            <h3>Funzionalit√† PRO</h3>
            <div class="content">
              <ul style="margin:0;padding-left:18px;line-height:1.6">
                <li><b>Curatela</b>: selezione capitoli migliori (voti + editor)</li>
                <li><b>Impaginazione</b>: PDF pronto (copertina + indice)</li>
                <li><b>Boost</b>: storia in evidenza in home</li>
                <li><b>Note</b>: coordinamento tra co-autori</li>
              </ul>
            </div>
          </div>

          <div class="panel">
            <h3>Nota</h3>
            <div class="content" style="color:rgba(255,255,255,.72)">
              Qui √® solo demo UI. Quando vuoi, implementiamo pagamenti e funzioni reali.
            </div>
          </div>
        </div>

        <div>
          <div class="panel" style="margin-top:0">
            <h3>Piano</h3>
            <div class="content">
              <div style="font-size:34px;font-weight:900;letter-spacing:-.02em">9‚Ç¨ <span style="font-size:14px;color:rgba(255,255,255,.7)">/ mese</span></div>
              <div style="color:rgba(255,255,255,.72);font-size:13px;margin-top:6px">Disdici quando vuoi.</div>
              <button class="btn primary" style="width:100%;margin-top:12px" id="proActivate2">Attiva PRO</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- EDITOR OVERLAY -->
  <div class="editor" id="editorOverlay">
    <div class="editorShell">
      <div class="editorTop">
        <button class="back" id="editorBack">‚Üê Indietro</button>
        <div class="title" id="editorModeTitle">Nuova storia</div>
        <button class="btn primary" id="publishBtn">Pubblica</button>
      </div>

      <div class="editorBody">
        <div class="box2">
          <h3>Dati racconto</h3>
          <div class="grid2">
            <div class="coverPick">
              <div class="coverPreview" id="coverPreview">
                <div style="padding:14px;text-align:center">
                  Clicca per caricare una copertina<br>
                  <span style="color:rgba(255,255,255,.55);font-size:12px">oppure usa un link sotto</span>
                </div>
                <div class="coverHint">clicca per cambiare copertina</div>
              </div>
              <input type="file" id="coverFile" accept="image/*" hidden>
              <input id="coverUrl" placeholder="Link copertina (RAW o URL immagine)" />
            </div>

            <input id="storyTitleInput" placeholder="Titolo" />
            <input id="storyAliasInput" placeholder="Firma / alias" />
            <select id="storyGenreInput">
              <option value="mistero">mistero</option>
              <option value="thriller">thriller</option>
              <option value="noir">noir</option>
              <option value="dramma">dramma</option>
              <option value="romance">romance</option>
              <option value="fantascienza">fantascienza</option>
              <option value="horror">horror</option>
              <option value="avventura">avventura</option>
              <option value="fantasy">fantasy</option>
              <option value="commedia">commedia</option>
            </select>

            <button class="btn ghost" id="clearDraft">Svuota bozza</button>
          </div>

          <div style="margin-top:12px;color:rgba(255,255,255,.65);font-size:12px;line-height:1.5">
            <b>Regola beabook:</b> massimo 30 righe per contributo. Quando arrivi al limite, devi fermarti.
          </div>
        </div>

        <div>
          <div class="toolbar">
            <button class="toolbtn" data-cmd="undo" title="Undo">‚Ü∂</button>
            <button class="toolbtn" data-cmd="redo" title="Redo">‚Ü∑</button>
            <span class="toolsep"></span>

            <button class="toolbtn" data-cmd="bold" title="Grassetto"><b>B</b></button>
            <button class="toolbtn" data-cmd="italic" title="Corsivo"><i>I</i></button>
            <button class="toolbtn" data-cmd="underline" title="Sottolineato"><u>U</u></button>
            <button class="toolbtn" data-cmd="strikeThrough" title="Barrato">S</button>

            <span class="toolsep"></span>

            <select class="toolsel" id="fontSel" title="Font">
              <option value="Georgia, serif">Serif (Georgia)</option>
              <option value="system-ui, -apple-system, Segoe UI, sans-serif" selected>Sans (System)</option>
              <option value="ui-monospace, SFMono-Regular, Menlo, monospace">Mono</option>
            </select>

            <select class="toolsel" id="sizeSel" title="Grandezza">
              <option value="14">14</option>
              <option value="16" selected>16</option>
              <option value="18">18</option>
              <option value="20">20</option>
              <option value="24">24</option>
            </select>

            <span class="toolsep"></span>

            <button class="toolbtn" data-cmd="justifyLeft" title="Allinea a sinistra">‚â°</button>
            <button class="toolbtn" data-cmd="justifyCenter" title="Centra">‚â£</button>
            <button class="toolbtn" data-cmd="justifyRight" title="Allinea a destra">‚â°</button>

            <span class="toolsep"></span>

            <button class="toolbtn" data-cmd="insertUnorderedList" title="Lista">‚Ä¢ list</button>
            <button class="toolbtn" data-cmd="insertOrderedList" title="Numerata">1. list</button>
          </div>

          <div id="editable" class="editable" contenteditable="true" spellcheck="true"></div>

          <div class="helpRow">
            <div id="lineCounter">0 / 30 righe</div>
            <div style="color:rgba(255,255,255,.60)">Suggerimento: vai a capo con Invio. Ogni riga conta.</div>
          </div>

          <div class="limitMsg" id="limitMsg">
            Limite delle trenta righe raggiunto. Aspetta che qualcuno continui la storia.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   STORAGE + SEED
========================= */
const STORAGE_KEY = "beabook_full_v1";

const GENRES = ["mistero","thriller","noir","dramma","romance","fantascienza","horror","avventura","fantasy","commedia"];

const seedStories = [
  {
    id:"s1",
    title:"La casa sulla scogliera",
    genre:"mistero",
    author:"Nora",
    cover:"https://raw.githubusercontent.com/jgnewland/bealove/main/1.jpg",
    incipitHtml:"<p>Il vento si arrampicava sui vetri come un ladro. Nora rest√≤ ferma, ascoltando il rumore del mare dietro il pub.</p>",
    chapters:[
      {id:"c1", author:"Anonimo", votes:6, createdAt: Date.now()-1000*60*60*6, html:"<p>La porta non cigol√≤. Peggio: si apr√¨ senza alcun suono, come se la casa l‚Äôavesse gi√† previsto.</p>"},
      {id:"c2", author:"Anonimo", votes:2, createdAt: Date.now()-1000*60*60*4, html:"<p>Dentro, l‚Äôodore non era di pioggia. Era di fumo vecchio e carta bagnata.</p>"}
    ],
    createdAt: Date.now()-1000*60*60*48
  },
  {
    id:"s2",
    title:"Fenit, ore 22:17",
    genre:"thriller",
    author:"John",
    cover:"https://raw.githubusercontent.com/jgnewland/bealove/main/2.jpg",
    incipitHtml:"<p>Alle 22:17 il telefono vibr√≤ due volte e poi tacque. John cap√¨ che qualcuno stava decidendo al posto suo.</p>",
    chapters:[],
    createdAt: Date.now()-1000*60*60*30
  },
  {
    id:"s3",
    title:"Il silenzio di Sam",
    genre:"dramma",
    author:"Anonimo",
    cover:"https://raw.githubusercontent.com/jgnewland/bealove/main/3.jpg",
    incipitHtml:"<p>Sam non parlava pi√π da settimane. Eppure quella sera la barca torn√≤ a riva come se avesse una voce.</p>",
    chapters:[
      {id:"c3", author:"Anonimo", votes:4, createdAt: Date.now()-1000*60*60*10, html:"<p>Sulla panca di poppa c‚Äôera una tazza di t√® caldo. Nessuno cap√¨ come potesse esserlo.</p>"}
    ],
    createdAt: Date.now()-1000*60*60*12
  },
  {
    id:"s4",
    title:"La stanza 24",
    genre:"noir",
    author:"Teresa",
    cover:"https://raw.githubusercontent.com/jgnewland/bealove/main/4.jpg",
    incipitHtml:"<p>Il numero 24 era inciso sul legno come una minaccia. Teresa pos√≤ la mano e sent√¨ il freddo passare attraverso la pelle.</p>",
    chapters:[],
    createdAt: Date.now()-1000*60*60*8
  },
  {
    id:"s5",
    title:"Mandorli in fiore",
    genre:"romance",
    author:"Salvo",
    cover:"https://raw.githubusercontent.com/jgnewland/bealove/main/5.jpg",
    incipitHtml:"<p>Non era stagione, eppure il profumo c‚Äôera. Un ricordo che non chiedeva permesso.</p>",
    chapters:[],
    createdAt: Date.now()-1000*60*60*5
  }
];

function loadStories(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return structuredClone(seedStories);
  try{
    const data = JSON.parse(raw);
    if(Array.isArray(data) && data.length) return data;
    return structuredClone(seedStories);
  }catch{
    return structuredClone(seedStories);
  }
}
function saveStories(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(stories));
}
let stories = loadStories();

/* =========================
   HELPERS
========================= */
function escapeHtml(str){
  return (str||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function contCount(s){ return (s.chapters||[]).length; }
function totalVotes(s){ return (s.chapters||[]).reduce((a,c)=>a+(c.votes||0),0); }
function shortTextFromHtml(html){
  const tmp = document.createElement("div");
  tmp.innerHTML = html || "";
  const t = (tmp.textContent || "").trim();
  return t.length > 110 ? t.slice(0,110)+"‚Ä¶" : (t || "Apri e continua la storia.");
}
function uid(prefix){
  return prefix + Math.random().toString(16).slice(2) + Date.now().toString(16);
}

/* =========================
   RENDER HOME ROWS
========================= */
const rowFeatured = document.getElementById("rowFeatured");
const rowNew = document.getElementById("rowNew");
const rowLoved = document.getElementById("rowLoved");

const featuredClickable = document.getElementById("featuredClickable");
const featuredTitle = document.getElementById("featuredTitle");
const featuredDesc = document.getElementById("featuredDesc");
const featuredGenre = document.getElementById("featuredGenre");

let featuredId = null;

function cardHTML(story){
  const stats = `${contCount(story)} cont. ¬∑ ${totalVotes(story)} ‚ù§`;
  const coverAttr = escapeHtml(story.cover || "");
  return `
    <div class="card" data-id="${story.id}">
      <div class="cover" data-cover="${coverAttr}">
        <div class="coverBad">Copertina non caricata</div>
        <div class="meta">
          <span class="genre">${escapeHtml(story.genre||"racconto")}</span>
          <div class="title">${escapeHtml(story.title)}</div>
        </div>
      </div>
      <div class="info">
        <div class="by">${escapeHtml(story.author||"Anonimo")}</div>
        <div class="stat">${stats}</div>
      </div>
    </div>
  `;
}

function applyCoverBackgrounds(root=document){
  root.querySelectorAll(".cover").forEach(div=>{
    const url = div.getAttribute("data-cover");
    if(!url){
      div.classList.add("bad");
      return;
    }
    const img = new Image();
    img.onload = () => {
      div.style.backgroundImage = `url('${url}')`;
      div.classList.remove("bad");
    };
    img.onerror = () => div.classList.add("bad");
    img.src = url;
  });
}

function setFeatured(story){
  if(!story) return;
  featuredId = story.id;
  featuredTitle.textContent = story.title;
  featuredGenre.textContent = story.genre || "racconto";
  featuredDesc.textContent = shortTextFromHtml(story.incipitHtml);

  if(story.cover){
    featuredClickable.style.backgroundImage =
      `linear-gradient(180deg, rgba(0,0,0,.00), rgba(0,0,0,.62)), url('${story.cover}')`;
  }else{
    featuredClickable.style.backgroundImage =
      `linear-gradient(135deg, rgba(180,91,99,.55), rgba(0,0,0,.35))`;
  }
}

function renderRows(list=stories){
  const featured = [...list].sort((a,b)=>contCount(b)-contCount(a)).slice(0,14);
  const newest = [...list].sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)).slice(0,14);
  const loved = [...list].sort((a,b)=>totalVotes(b)-totalVotes(a)).slice(0,14);

  rowFeatured.innerHTML = featured.map(cardHTML).join("");
  rowNew.innerHTML = newest.map(cardHTML).join("");
  rowLoved.innerHTML = loved.map(cardHTML).join("");

  document.querySelectorAll(".card").forEach(el=>{
    el.addEventListener("click", ()=> openStory(el.dataset.id));
  });

  applyCoverBackgrounds();
  setFeatured(featured[0] || list[0]);
}

featuredClickable.addEventListener("click", ()=>{ if(featuredId) openStory(featuredId); });

/* =========================
   SEARCH + GENRE SUGGEST
========================= */
const q = document.getElementById("q");
const suggest = document.getElementById("suggest");
const chips = document.getElementById("chips");

chips.innerHTML = GENRES.map(g=>`<span class="chip" data-g="${g}">${g}</span>`).join("");
chips.querySelectorAll(".chip").forEach(ch=>{
  ch.addEventListener("click", ()=>{
    q.value = ch.dataset.g;
    suggest.classList.remove("open");
    runSearch();
  });
});

function runSearch(){
  const term = q.value.trim().toLowerCase();
  if(!term){
    renderRows(stories);
    return;
  }
  const filtered = stories.filter(s =>
    (s.title||"").toLowerCase().includes(term) ||
    (s.author||"").toLowerCase().includes(term) ||
    (s.genre||"").toLowerCase().includes(term) ||
    shortTextFromHtml(s.incipitHtml).toLowerCase().includes(term)
  );
  renderRows(filtered);
}

q.addEventListener("focus", ()=> suggest.classList.add("open"));
q.addEventListener("blur", ()=> setTimeout(()=>suggest.classList.remove("open"), 140));
q.addEventListener("input", runSearch);

window.addEventListener("keydown", (e)=>{
  if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="k"){
    e.preventDefault(); q.focus(); suggest.classList.add("open");
  }
});

/* =========================
   NAV + BUTTONS
========================= */
document.getElementById("browseBtn").addEventListener("click", ()=>{
  document.getElementById("featured").scrollIntoView({behavior:"smooth", block:"start"});
});
document.getElementById("randomBtn").addEventListener("click", ()=>{
  const pick = stories[Math.floor(Math.random()*stories.length)];
  openStory(pick.id);
});
document.getElementById("openProBtn").addEventListener("click", ()=> openPro());
document.getElementById("proCtaBtn").addEventListener("click", ()=> openPro());

/* =========================
   ‚úÖ HAMBURGER MENU (UNICO, PULITO)
   apre/chiude #menuOverlay
========================= */
const hambBtn = document.getElementById("hambBtn");
const menuOverlay = document.getElementById("menuOverlay");
const menuClose = document.getElementById("menuClose");

function openMenu(){
  if(!menuOverlay) return;
  menuOverlay.classList.add("open");
  menuOverlay.setAttribute("aria-hidden","false");
  document.body.style.overflow = "hidden";
}
function closeMenu(){
  if(!menuOverlay) return;
  menuOverlay.classList.remove("open");
  menuOverlay.setAttribute("aria-hidden","true");
  document.body.style.overflow = "";
}

if(hambBtn) hambBtn.addEventListener("click", openMenu);
if(menuClose) menuClose.addEventListener("click", closeMenu);

if(menuOverlay){
  menuOverlay.addEventListener("click", (e)=>{
    if(e.target === menuOverlay) closeMenu();
  });
  menuOverlay.querySelectorAll('a[href^="#"]').forEach(a=>{
    a.addEventListener("click", ()=> closeMenu());
  });
}

window.addEventListener("keydown", (e)=>{
  if(e.key === "Escape" && menuOverlay?.classList.contains("open")){
    closeMenu();
  }
});

/* =========================
   STORY OVERLAY
========================= */
const storyOverlay = document.getElementById("storyOverlay");
const storyBack = document.getElementById("storyBack");
const continueBtn = document.getElementById("continueBtn");

const storyCoverImg = document.getElementById("storyCoverImg");
const storyCoverClick = document.getElementById("storyCoverClick");
const storyGenre = document.getElementById("storyGenre");
const storyTitle = document.getElementById("storyTitle");
const storyMeta = document.getElementById("storyMeta");
const storyIncipit = document.getElementById("storyIncipit");
const storyStats = document.getElementById("storyStats");
const chapList = document.getElementById("chapList");
const chapSort = document.getElementById("chapSort");
const chapFilter = document.getElementById("chapFilter");

let currentStoryId = null;

function openStory(id){
  const s = stories.find(x=>x.id===id);
  if(!s) return;
  currentStoryId = id;

  storyCoverImg.src = s.cover || "";
  storyGenre.textContent = s.genre || "racconto";
  storyTitle.textContent = s.title;
  storyMeta.textContent = `di ${s.author || "Anonimo"}`;
  storyIncipit.innerHTML = s.incipitHtml || "";
  storyStats.textContent = `${contCount(s)} continuazioni ¬∑ ${totalVotes(s)} ‚ù§`;

  chapSort.value = "top";
  chapFilter.value = "";
  renderChapters();

  storyOverlay.classList.add("open");
  document.body.style.overflow="hidden";
}

function closeStory(){
  storyOverlay.classList.remove("open");
  document.body.style.overflow="";
}

function renderChapters(){
  const s = stories.find(x=>x.id===currentStoryId);
  if(!s) return;
  let ch = [...(s.chapters||[])];

  const term = chapFilter.value.trim().toLowerCase();
  if(term){
    ch = ch.filter(c=>{
      const tmp = document.createElement("div");
      tmp.innerHTML = c.html || "";
      return (tmp.textContent||"").toLowerCase().includes(term) ||
             (c.author||"").toLowerCase().includes(term);
    });
  }

  if(chapSort.value === "new"){
    ch.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  } else {
    ch.sort((a,b)=>(b.votes||0)-(a.votes||0));
  }

  if(!ch.length){
    chapList.innerHTML = `<div class="chap"><div class="content" style="color:rgba(255,255,255,.75)">Nessuna continuazione (o nessun risultato).</div></div>`;
    return;
  }

  chapList.innerHTML = ch.map(c=>`
    <div class="chap">
      <div class="content">${c.html || ""}</div>
      <div class="foot">
        <span>‚Äî ${escapeHtml(c.author||"Anonimo")}</span>
        <button class="vote" data-cid="${c.id}">‚ù§ <b>${c.votes||0}</b></button>
      </div>
    </div>
  `).join("");

  chapList.querySelectorAll(".vote").forEach(btn=>{
    btn.addEventListener("click", ()=> voteChapter(btn.dataset.cid));
  });
}

function voteChapter(cid){
  const s = stories.find(x=>x.id===currentStoryId);
  if(!s) return;
  const c = (s.chapters||[]).find(x=>x.id===cid);
  if(!c) return;
  c.votes = (c.votes||0)+1;
  saveStories();
  storyStats.textContent = `${contCount(s)} continuazioni ¬∑ ${totalVotes(s)} ‚ù§`;
  renderChapters();
  renderRows();
}

chapSort.addEventListener("change", renderChapters);
chapFilter.addEventListener("input", renderChapters);
storyBack.addEventListener("click", closeStory);
storyOverlay.addEventListener("click", (e)=>{ if(e.target===storyOverlay) closeStory(); });

/* Cover lightbox */
const lightbox = document.getElementById("lightbox");
const lightboxImg = document.getElementById("lightboxImg");
storyCoverClick.addEventListener("click", ()=>{
  if(!storyCoverImg.src) return;
  lightboxImg.src = storyCoverImg.src;
  lightbox.classList.add("open");
});
lightbox.addEventListener("click", ()=> lightbox.classList.remove("open"));

/* =========================
   PRO OVERLAY
========================= */
const proOverlay = document.getElementById("proOverlay");
document.getElementById("proBack").addEventListener("click", closePro);
proOverlay.addEventListener("click", (e)=>{ if(e.target===proOverlay) closePro(); });

function openPro(){
  proOverlay.classList.add("open");
  document.body.style.overflow="hidden";
}
function closePro(){
  proOverlay.classList.remove("open");
  document.body.style.overflow="";
}
function proActivate(){
  alert("Demo UI: qui attiveremo PRO (pagamento + funzioni).");
}
document.getElementById("proActivate").addEventListener("click", proActivate);
document.getElementById("proActivate2").addEventListener("click", proActivate);

/* =========================
   EDITOR (NEW STORY / CONTINUE)
========================= */
const editorOverlay = document.getElementById("editorOverlay");
const editorBack = document.getElementById("editorBack");
const publishBtn = document.getElementById("publishBtn");
const editorModeTitle = document.getElementById("editorModeTitle");

const coverPreview = document.getElementById("coverPreview");
const coverFile = document.getElementById("coverFile");
const coverUrl = document.getElementById("coverUrl");

const storyTitleInput = document.getElementById("storyTitleInput");
const storyAliasInput = document.getElementById("storyAliasInput");
const storyGenreInput = document.getElementById("storyGenreInput");

const editable = document.getElementById("editable");
const lineCounter = document.getElementById("lineCounter");
const limitMsg = document.getElementById("limitMsg");

const fontSel = document.getElementById("fontSel");
const sizeSel = document.getElementById("sizeSel");

const clearDraftBtn = document.getElementById("clearDraft");

let editorState = { mode: "new", storyId: null, coverDataUrl: "" };
const DRAFT_KEY = "beabook_editor_draft_v1";

/* Toolbar */
document.querySelectorAll(".toolbtn[data-cmd]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const cmd = btn.dataset.cmd;
    editable.focus();
    document.execCommand(cmd, false, null);
    enforceLineLimit();
  });
});

function applyEditorStyle(){
  editable.style.fontFamily = fontSel.value;
  editable.style.fontSize = `${parseInt(sizeSel.value,10)}px`;
}
fontSel.addEventListener("change", applyEditorStyle);
sizeSel.addEventListener("change", applyEditorStyle);

/* Cover upload */
coverPreview.addEventListener("click", ()=> coverFile.click());
coverFile.addEventListener("change", ()=>{
  const f = coverFile.files?.[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    editorState.coverDataUrl = String(reader.result || "");
    setCoverPreview(editorState.coverDataUrl);
    saveDraft();
  };
  reader.readAsDataURL(f);
});

/* Cover URL */
coverUrl.addEventListener("input", ()=>{
  const url = coverUrl.value.trim();
  if(url){
    editorState.coverDataUrl = "";
    setCoverPreview(url);
  }else{
    setCoverPreview("");
  }
  saveDraft();
});

function setCoverPreview(src){
  if(!src){
    coverPreview.classList.remove("has");
    coverPreview.innerHTML = `<div style="padding:14px;text-align:center">Clicca per caricare una copertina<br><span style="color:rgba(255,255,255,.55);font-size:12px">oppure usa un link sotto</span></div><div class="coverHint">clicca per cambiare copertina</div>`;
    return;
  }
  coverPreview.classList.add("has");
  coverPreview.innerHTML = `<img alt="preview" src="${src}"><div class="coverHint">clicca per cambiare copertina</div>`;
}

/* Line limit */
function getLineCountFromText(text){
  const t = (text || "").replace(/\r/g,"");
  if(!t.trim()) return 0;
  return t.split("\n").length;
}
function normalizeToPlainTextWithNewlines(){
  return editable.innerText.replace(/\r/g,"");
}
function enforceLineLimit(){
  const txt = normalizeToPlainTextWithNewlines();
  const lines = getLineCountFromText(txt);
  lineCounter.textContent = `${Math.min(lines,30)} / 30 righe`;

  if(lines >= 30){
    limitMsg.classList.add("show");
    const cut = txt.split("\n").slice(0,30).join("\n");
    editable.innerText = cut;
    placeCaretAtEnd(editable);
    return;
  }
  limitMsg.classList.remove("show");
}
function placeCaretAtEnd(el){
  el.focus();
  const range = document.createRange();
  range.selectNodeContents(el);
  range.collapse(false);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
}

editable.addEventListener("input", ()=>{
  enforceLineLimit();
  saveDraft();
});
editable.addEventListener("paste", ()=>{
  setTimeout(()=>{ enforceLineLimit(); saveDraft(); }, 0);
});

/* Draft */
function saveDraft(){
  const draft = {
    mode: editorState.mode,
    storyId: editorState.storyId,
    coverUrl: coverUrl.value,
    coverDataUrl: editorState.coverDataUrl,
    title: storyTitleInput.value,
    alias: storyAliasInput.value,
    genre: storyGenreInput.value,
    html: editable.innerHTML,
    font: fontSel.value,
    size: sizeSel.value
  };
  localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
}
function loadDraft(){
  const raw = localStorage.getItem(DRAFT_KEY);
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch{ return null; }
}
function clearDraft(){
  localStorage.removeItem(DRAFT_KEY);
}

/* Open editor */
function openEditor({mode, storyId=null}){
  editorState.mode = mode;
  editorState.storyId = storyId;
  editorState.coverDataUrl = "";

  editorModeTitle.textContent = mode === "new" ? "Nuova storia" : "Continua la storia";

  coverUrl.value = "";
  storyTitleInput.value = "";
  storyAliasInput.value = "";
  storyGenreInput.value = "mistero";
  editable.innerHTML = "";
  fontSel.value = "system-ui, -apple-system, Segoe UI, sans-serif";
  sizeSel.value = "16";
  applyEditorStyle();
  setCoverPreview("");

  if(mode === "continue"){
    const s = stories.find(x=>x.id===storyId);
    if(s){
      storyTitleInput.value = s.title;
      storyAliasInput.value = "";
      storyGenreInput.value = s.genre || "mistero";
      setCoverPreview(s.cover || "");
      storyTitleInput.disabled = true;
      storyGenreInput.disabled = true;
      coverUrl.disabled = true;
      coverPreview.style.pointerEvents = "none";
      coverPreview.style.opacity = ".85";
      coverUrl.placeholder = "Copertina bloccata";
    }
  } else {
    storyTitleInput.disabled = false;
    storyGenreInput.disabled = false;
    coverUrl.disabled = false;
    coverPreview.style.pointerEvents = "";
    coverPreview.style.opacity = "";
    coverUrl.placeholder = "Link copertina (RAW o URL immagine)";
  }

  const d = loadDraft();
  if(d && d.mode === mode && (mode==="new" || d.storyId === storyId)){
    coverUrl.value = d.coverUrl || "";
    editorState.coverDataUrl = d.coverDataUrl || "";
    storyTitleInput.value = d.title || storyTitleInput.value;
    storyAliasInput.value = d.alias || "";
    storyGenreInput.value = d.genre || storyGenreInput.value;
    editable.innerHTML = d.html || "";
    if(d.font) fontSel.value = d.font;
    if(d.size) sizeSel.value = d.size;
    applyEditorStyle();
    const previewSrc = coverUrl.value.trim() || editorState.coverDataUrl || (mode==="continue" ? (stories.find(x=>x.id===storyId)?.cover||"") : "");
    setCoverPreview(previewSrc);
  }

  enforceLineLimit();
  editorOverlay.classList.add("open");
  document.body.style.overflow="hidden";
  setTimeout(()=> editable.focus(), 50);
}
window.openEditor = openEditor; // esponi per auth-bridge

/* Close editor */
function closeEditor(){
  editorOverlay.classList.remove("open");
  document.body.style.overflow="";
}
editorBack.addEventListener("click", closeEditor);

/* Clear draft */
clearDraftBtn.addEventListener("click", ()=>{
  if(confirm("Svuotare la bozza?")){
    clearDraft();
    openEditor({mode: editorState.mode, storyId: editorState.storyId});
  }
});

/* Publish helpers */
function validateLines(){
  const lines = getLineCountFromText(normalizeToPlainTextWithNewlines());
  return lines <= 30;
}
function getFinalCoverForNewStory(){
  const url = coverUrl.value.trim();
  if(url) return url;
  if(editorState.coverDataUrl) return editorState.coverDataUrl;
  return "";
}
function cleanHtml(html){
  const tmp = document.createElement("div");
  tmp.innerHTML = html || "";
  tmp.querySelectorAll("script").forEach(s=>s.remove());
  return tmp.innerHTML.trim();
}

/* Publish */
publishBtn.addEventListener("click", ()=>{
  enforceLineLimit();
  if(!validateLines()){
    alert("Hai superato il limite di 30 righe.");
    return;
  }
  const alias = storyAliasInput.value.trim() || "Anonimo";
  const html = cleanHtml(editable.innerHTML);
  if(!html || !html.replace(/<[^>]*>/g,"").trim()){
    alert("Scrivi almeno qualcosa.");
    return;
  }

  if(editorState.mode === "new"){
    const title = storyTitleInput.value.trim();
    if(!title){ alert("Inserisci un titolo."); return; }
    const genre = storyGenreInput.value;
    const cover = getFinalCoverForNewStory();
    const newStory = {
      id: uid("s"),
      title,
      genre,
      author: alias,
      cover,
      incipitHtml: html,
      chapters: [],
      createdAt: Date.now()
    };
    stories.unshift(newStory);
    saveStories();
    clearDraft();
    closeEditor();
    renderRows();
    openStory(newStory.id);
    return;
  }

  if(editorState.mode === "continue"){
    const s = stories.find(x=>x.id===editorState.storyId);
    if(!s){ alert("Storia non trovata."); return; }
    s.chapters = s.chapters || [];
    s.chapters.unshift({
      id: uid("c"),
      author: alias,
      votes: 0,
      createdAt: Date.now(),
      html
    });
    saveStories();
    clearDraft();
    closeEditor();
    storyStats.textContent = `${contCount(s)} continuazioni ¬∑ ${totalVotes(s)} ‚ù§`;
    renderChapters();
    renderRows();
    return;
  }
});

/* ESC handling */
window.addEventListener("keydown", (e)=>{
  if(e.key === "Escape"){
    if(lightbox.classList.contains("open")) lightbox.classList.remove("open");
    else if(editorOverlay.classList.contains("open")) closeEditor();
    else if(proOverlay.classList.contains("open")) closePro();
    else if(storyOverlay.classList.contains("open")) closeStory();
  }
});

/* init UI */
renderRows();

/* BUTTONS -> ora usano window.openEditor (cos√¨ l‚Äôauth bridge li protegge) */
document.getElementById("newStoryBtn").addEventListener("click", ()=>{
  window.openEditor({mode:"new"});
});
continueBtn.addEventListener("click", ()=>{
  if(!currentStoryId) return;
  window.openEditor({mode:"continue", storyId: currentStoryId});
});
</script>

<!-- ‚úÖ SUPABASE UMD (deve stare PRIMA del bridge) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* =========================
   BEABOOK AUTH (INDEX) ‚Äî FIX SESSION
========================= */

const SUPABASE_URL = "https://cjzjipuwdviorqsihsmr.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_GTdIzH-9DAlh39wyKfPIZA_rtxwek0O";

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const bbUserBadge = document.getElementById("bbUserBadge");
const bbLoginBtn  = document.getElementById("bbLoginBtn");
const bbLogoutBtn = document.getElementById("bbLogoutBtn");

let bbUser = null;
let bbDisplayName = "";

function bbRenderLoggedOut(){
  bbUser = null;
  bbDisplayName = "";
  if (bbUserBadge) bbUserBadge.textContent = "";
  if (bbLoginBtn)  bbLoginBtn.style.display = "";
  if (bbLogoutBtn) bbLogoutBtn.style.display = "none";
}

function bbRenderLoggedIn(){
  if (bbUserBadge) bbUserBadge.textContent = "Ciao, " + bbDisplayName;
  if (bbLoginBtn)  bbLoginBtn.style.display = "none";
  if (bbLogoutBtn) bbLogoutBtn.style.display = "";
}

async function bbEnsureProfile(user){
  const { data: profile, error } = await sb
    .from("profiles")
    .select("username")
    .eq("id", user.id)
    .maybeSingle();

  if (!profile && !error){
    const fallback =
      user.user_metadata?.username ||
      (user.email ? user.email.split("@")[0] : "utente");

    await sb.from("profiles").upsert({
      id: user.id,
      username: fallback,
      updated_at: new Date().toISOString()
    });

    const r = await sb.from("profiles").select("username").eq("id", user.id).maybeSingle();
    return r.data || null;
  }

  return profile || null;
}

async function bbFetch(){
  const { data: { session } } = await sb.auth.getSession();
  const user = session?.user || null;

  if(!user){
    bbRenderLoggedOut();
    return;
  }

  bbUser = user;

  const profile = await bbEnsureProfile(user);
  bbDisplayName = profile?.username || user.email || "utente";

  bbRenderLoggedIn();
}

if (bbLoginBtn){
  bbLoginBtn.addEventListener("click", ()=> window.location.href = "./auth.html");
}
if (bbLogoutBtn){
  bbLogoutBtn.addEventListener("click", async ()=>{
    await sb.auth.signOut();
    await bbFetch();
    alert("Logout effettuato.");
  });
}

sb.auth.onAuthStateChange(()=>{
  bbFetch();
});

bbFetch();
</script>

<!-- MOBILE MENU OVERLAY -->
<div class="overlay" id="menuOverlay" aria-hidden="true">
  <div class="sheet" style="max-width:520px;margin:0 auto;inset:12px;position:absolute;left:0;right:0;top:12px;bottom:auto;">
    <div class="sheet-top">
      <button class="back" id="menuClose">‚Üê Chiudi</button>
      <div class="sheet-title">Menu</div>
      <span></span>
    </div>

    <div style="padding:14px">
      <div style="display:flex;flex-direction:column;gap:10px">
        <a class="toolbtn" href="#home">Home</a>
        <a class="toolbtn" href="#featured">In evidenza</a>
        <a class="toolbtn" href="#new">Nuove</a>
        <a class="toolbtn" href="#loved">Pi√π amate</a>
      </div>
    </div>
  </div>
</div>

</body>
</html>
